<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Password</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Font Awesome (working CDN) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: url('../../img/bgimg.jpg') center/cover no-repeat fixed;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    .page-wrapper { position: relative; width: 100%; max-width: 520px; padding: 0 20px; }

    .card {
      width: 100%;
      border-radius: 28px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      padding: 48px 28px;
      position: relative;
      overflow: hidden;
    }

    .heart-bg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 320px;
      background: radial-gradient(circle at center, rgba(255, 77, 109, 0.3), transparent 70%);
      clip-path: path("M24 80 C24 24, 128 -24, 256 80 C384 -24, 488 24, 488 80 C488 216, 256 424, 256 424 C256 424, 24 216, 24 80 Z");
      z-index: 0;
    }

    .title { font-family: 'Inter', sans-serif; font-size: 26px; color: #000; margin-bottom: 40px; font-weight: 500; position: relative; z-index: 2; }

    label {
      display: block;
      text-align: left;
      font-size: 14px;
      color: #111;
      margin-bottom: 6px;
      margin-top: 14px;
      position: relative;
      z-index: 2;
    }

    .input-wrapper {
      position: relative;
      z-index: 2;
    }

    input[type="password"],
    input[type="text"] {
    width: 100%;
    padding: 10px 44px 10px 14px;
    border-radius: 12px;
    border: 1px solid rgba(255, 100, 130, 0.5);
    background: rgba(255, 255, 255, 0.25);
    color: #111;
    font-size: 15px;
    outline: none;
    transition: 0.25s ease;
    backdrop-filter: blur(10px);
    }

    input[type="password"]:focus,
    input[type="text"]:focus {
    border-color: rgba(255, 120, 150, 0.9);
    box-shadow: 0 0 8px rgba(255, 120, 150, 0.4);
    }

    .toggle-eye {
      position: absolute;
      top: 50%;
      right: 14px;
      transform: translateY(-50%);
      cursor: pointer;
      opacity: 0.6;
      transition: 0.25s ease;
    }

    .toggle-eye:hover {
      opacity: 1;
      transform: translateY(-50%) scale(1.1);
    }

    .btn-soft { width: 50%; margin-top: 32px; padding: 10px 36px; font-weight: 500; font-size: 16px; border-radius: 55px; border-width: 0.11rem; border-style: solid; border-top-color: #ffffffcc; border-bottom-color: #ffffffcc; border-left-color: #fa97a9; border-right-color: #fa97a9; background: linear-gradient(135deg, #F78998 0%, #fa97a9 50%, #F78998 100%); box-shadow: 0px 36.86px 13.98px rgba(255, 106, 106, 0.02), 0px 20.34px 12.71px rgba(255, 106, 106, 0.08), 0px 8.9px 8.9px rgba(255, 106, 106, 0.13), 0px 2.54px 5.08px rgba(255, 106, 106, 0.15); position: relative; overflow: hidden; transition: 0.25s ease; }
    .btn-soft::before { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 40%, rgba(255,255,255,0) 60%, rgba(255,255,255,0.35) 100%); border-radius: 55px; pointer-events: none; }
    .btn-soft:hover { transform: translateY(-2px) scale(1.02); }

    /* Spinner used by Continue button */
    .loading { display:inline-block; width:16px; height:16px; border:3px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s linear infinite; margin-left:8px; }
    .hidden { display:none !important; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .back-btn {
      position: absolute;
      top: 28px;
      left: 28px;
      background: linear-gradient(145deg, rgba(255,255,255,0.7), rgba(255,255,255,0.25));
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 22px;
      color: #111;
      font-size: 16px;
      padding: 8px 22px;
      font-weight: 500;
      box-shadow:
        inset 0 1px 2px rgba(255,255,255,0.9),
        0 4px 10px rgba(255,150,170,0.4);
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      z-index: 3;
    }

    .back-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(255,140,170,0.8);
    }


     .modal-content {
  width: min(720px, calc(100% - 32px));
  max-height: 35vh; /* <-- limit height to 80% of viewport */
  margin-top: 28px;
  border-radius: 12px;
  overflow: hidden;
  backdrop-filter: blur(10px);
  background: rgba(255,255,255,0.85);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
}

/* Body scroll */
.modal-body {
  padding: 16px;
  overflow-y: auto;  /* <-- scroll vertically if content is too tall */
  flex: 1 1 auto;    /* take remaining space in modal */
}

#uploadGuidanceModal {
  display: none; /* hidden by default */
  position: fixed;
  inset: 0;
  justify-content: center;
  align-items: flex-start; /* top pop-up */
  z-index: 9999;
}

/* NEW: visible state */
#uploadGuidanceModal.open {
  display: flex;
  pointer-events: auto;
  animation: slideDown 260ms ease-out;
}

@keyframes slideDown {
  from { transform: translateY(-10px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}

/* UPDATED modal content to be a top bar with responsive width */
.modal-content {
  width: min(720px, calc(100% - 32px));
  margin-top: 28px;    /* distance from viewport top */
  border-radius: 12px;
  overflow: hidden;
  backdrop-filter: blur(10px);
   background: rgba(255,255,255,0.85);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

/* NEW: header bar (red/pink) */
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: linear-gradient(90deg,#F78998,#fa97a9 60%);
  color: white;
}

/* NEW: header title */
.modal-header h2 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
}

/* NEW: close button using Font Awesome */
.modal-close-button {
  background: transparent;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
}
.modal-close-button:focus { outline: 2px solid rgba(255,255,255,0.3); }

/* small-screen tweak */
@media (max-width:420px) {
  .modal-content { width: calc(100% - 16px); margin-top: 16px; }
  .modal-header h2 { font-size: 0.95rem; }
}


.info-icon {
  font-size: 20px;
  color: black;
  cursor: pointer;
  position: absolute;
  top: 16px;
  right: 16px;
  z-index: 10;
}

.custom-leading {
  line-height: 1.6; /* adjust this value as needed */
}



  </style>
</head>

<body>
  <div class="page-wrapper">
    <a href="StudentId1Holder.html" class="back-btn flex items-center justify-center gap-2"><i class="fa-solid fa-arrow-left"></i><span class="font-serif leading-none">Back</span></a>

  <div class="card animate-float">
    <div class="heart-bg"></div>

    <h2 class="title">Password</h2>

    <form onsubmit="return false;">
      <label for="username">Username</label>
      <div class="input-wrapper">
        <input type="text" id="username" placeholder="Enter username (3-30 characters)" />
      </div>

      <label for="password">Enter Password</label>
      <div class="input-wrapper">
        <input type="password" id="password" />
        <img src="../../img/eye.svg" class="toggle-eye" onclick="togglePassword('password', this)" alt="eye icon">
      </div>

      <label for="confirm">Confirm Password</label>
      <div class="input-wrapper">
        <input type="password" id="confirm" />
        <img src="../../img/eye.svg" class="toggle-eye" onclick="togglePassword('confirm', this)" alt="eye icon">
      </div>

      <button id="continueBtn" class="btn-soft mt-6"><span class="btn-text">Continue</span><span class="loading hidden"></span></button>
    </form>
  </div>
  </div>

  <script>
    function togglePassword(id, icon) {
    const input = document.getElementById(id);
    if (input.type === "password") {
        input.type = "text";
        icon.src = "../../img/eye-off.svg";
    } else {
        input.type = "password";
        icon.src = "../../img/eye.svg";
    }
    }

    // Get nickname from first name for default username suggestion
    function getNickname() {
      const firstName = localStorage.getItem('firstName') || '';
      return firstName.toLowerCase().replace(/[^a-z0-9._]/g, '');
    }

    // Set default username on load
    document.addEventListener('DOMContentLoaded', () => {
      const usernameInput = document.getElementById('username');
      usernameInput.value = getNickname();
    });

    document.getElementById('continueBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('continueBtn');
      const text = btn.querySelector('.btn-text');
      const loader = btn.querySelector('.loading');

      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirm').value;

      // Basic client validation (same rules as collectPageData)
      if (!username) { alert('⚠️ Username is required.'); return; }
      if (username.length < 3 || username.length > 30) { alert('⚠️ Username must be between 3 and 30 characters.'); return; }
      if (!/^[a-z0-9._]+$/.test(username)) { alert('⚠️ Username may contain lowercase letters, numbers, dot and underscore only.'); return; }
      if (!password) { alert('⚠️ Password is required.'); return; }
      if (password.length < 8) { alert('⚠️ Password must be at least 8 characters long.'); return; }
      if (password !== confirm) { alert('⚠️ Passwords do not match.'); return; }

      // show spinner
      try { btn.disabled = true; if (text) text.textContent = 'Checking...'; if (loader) loader.classList.remove('hidden'); } catch(e){}

      try {
        const res = await fetch(`/api/v1/register/check-username?username=${encodeURIComponent(username)}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Username check failed');
        if (!data.available) {
          alert('⚠️ Username already taken. Please choose another.');
          // restore state
          btn.disabled = false; if (text) text.textContent = 'Continue'; if (loader) loader.classList.add('hidden');
          return;
        }

        // Save locally and proceed
        localStorage.setItem('username', username);
        localStorage.setItem('password', password);
        document.dispatchEvent(new Event('registration:submit'));
      } catch (err) {
        alert(err.message || 'Failed to check username');
        btn.disabled = false; if (text) text.textContent = 'Continue'; if (loader) loader.classList.add('hidden');
      }
    });

    // Registration hooks
    window.prefillPage = function(prefill) {
      const username = prefill.username ?? localStorage.getItem('username') ?? '';
      document.getElementById('username').value = username;
    };

    window.collectPageData = function() {
      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const confirm = document.getElementById('confirm').value;

      // Validation (same rules)
      if (!username) {
        alert('⚠️ Username is required.');
        return null;
      }
      if (username.length < 3 || username.length > 30) {
        alert('⚠️ Username must be between 3 and 30 characters.');
        return null;
      }
      if (!/^[a-z0-9._]+$/.test(username)) {
        alert('⚠️ Username may contain lowercase letters, numbers, dot and underscore only.');
        return null;
      }

      if (!password) {
        alert('⚠️ Password is required.');
        return null;
      }
      if (password.length < 8) {
        alert('⚠️ Password must be at least 8 characters long.');
        return null;
      }

      if (password !== confirm) {
        alert('⚠️ Passwords do not match.');
        return null;
      }

      localStorage.setItem('username', username);
      localStorage.setItem('password', password);
      return { username, password, passwordConfirm: confirm };
    };
  </script>
  </script>
  <script type="module" src="/js/registration.js"></script>
</body>
</html>
